# Nexmed EHR 솔루션 구조 및 작동 방식 설명서

## 📋 목차
1. [전체 구조 개요](#전체-구조-개요)
2. [계층별 프로젝트 구조](#계층별-프로젝트-구조)
3. [주요 프로젝트 상세 설명](#주요-프로젝트-상세-설명)
4. [작동 방식](#작동-방식)
5. [보안 관련 사항](#보안-관련-사항)
6. [프로젝트 간 의존성 관계](#프로젝트-간-의존성-관계)

---

## 전체 구조 개요

Nexmed EHR은 델파이(Delphi)로 작성된 대규모 의료정보시스템(EHR) 솔루션입니다. 
전체 구조는 **계층형 아키텍처(Layered Architecture)**로 설계되어 있으며, 
각 계층은 명확한 역할과 책임을 가지고 있습니다.

### 전체 디렉토리 구조
```
SRC/
├── MAiN/          # 메인 애플리케이션 (최상위 실행 프로그램)
├── LOGIN/          # 로그인 및 로더 프로그램
├── COM_LV0/        # Level 0: 외부 라이브러리 및 기본 유틸리티
├── COM_LV1/        # Level 1: 써드파티 컴포넌트 (DevExpress, TMS 등)
├── COM_LV2/        # Level 2: SMC 프레임워크 및 핵심 비즈니스 로직
├── COM_LV3/        # Level 3: 고급 기능 및 특수 컴포넌트
├── MDI/            # 의료진 인터페이스 모듈
├── MDC/            # 의료진 관리 모듈
├── SD/             # 시스템 관리 모듈
├── EMR/            # 전자의무기록 모듈
└── 기타 모듈들...
```

---

## 계층별 프로젝트 구조

### 📦 COM_LV0 (Level 0: 기본 라이브러리)
**역할**: 가장 낮은 수준의 기본 유틸리티 및 외부 라이브러리 래퍼

**주요 패키지**:
- **CommonPack**: 공통 함수, 암호화(DCPsha256, DCPbase64), 기본 유틸리티
- **ExternalPack**: 외부 OCX/DLL 래퍼 (이미지뷰어, 프린터, 스캐너 등)
- **CPortLib**: 시리얼 포트 통신 라이브러리
- **BarcodePack**: 바코드 처리 라이브러리
- **ZipMaster**: 파일 압축/해제 라이브러리
- **Rexpert**: 리포트 생성 라이브러리

**특징**:
- 다른 모든 레벨의 기반이 되는 최하위 계층
- 외부 의존성이 없음 (rtl, vcl만 사용)
- 재사용 가능한 기본 기능 제공

---

### 📦 COM_LV1 (Level 1: 써드파티 컴포넌트)
**역할**: 상용 컴포넌트 라이브러리 통합

**주요 패키지**:
- **DevExpress**: UI 컴포넌트 (Grid, Editor, Scheduler 등)
- **TMS**: 추가 UI 컴포넌트
- **SynEdit**: 코드 에디터 컴포넌트
- **kbmMemTable**: 메모리 테이블 컴포넌트
- **MQTT**: MQTT 프로토콜 지원

**특징**:
- 상용 라이브러리들의 통합 계층
- COM_LV0에 의존
- UI 및 데이터 처리 컴포넌트 제공

---

### 📦 COM_LV2 (Level 2: SMC 프레임워크)
**역할**: 핵심 비즈니스 프레임워크 및 애플리케이션 로직

**주요 패키지**:
- **SMC**: 메인 프레임워크 (폼 관리, 메시지 처리, 도킹 등)
- **SMCExpress**: DevExpress 기반 확장 컴포넌트
- **SEHRCore**: EHR 핵심 데이터 모델
- **SEHRData**: 데이터셋 및 데이터 프로바이더
- **SMCService**: 서비스 레이어
- **SMCCert**: 인증서 처리
- **SMCHttp**: HTTP 통신
- **SMCCall**: 호출 버스 시스템

**핵심 기능**:
- 폼 관리 시스템 (SMCFormManager)
- 메시지 다이얼로그 시스템
- 도킹 컨트롤 시스템
- 데이터 프로바이더/데이터셋 프레임워크
- 메뉴 및 툴바 관리

**특징**:
- COM_LV0, COM_LV1에 의존
- 애플리케이션의 핵심 아키텍처 제공
- 비즈니스 로직의 기반이 되는 프레임워크

---

### 📦 COM_LV3 (Level 3: 고급 기능)
**역할**: 특수 기능 및 고급 컴포넌트

**주요 패키지**:
- **NRCViewerPackage**: 의무기록 뷰어 (레거시 및 신규)
- **SMCExport**: 데이터 내보내기 (Excel, CSV 등)
- **SMCFax**: 팩스 처리
- **SMCLProxy**: 프록시 및 링커
- **ScreenSecurityPack**: 화면 보안 (스크린샷 방지 등)
- **SMCIFFile**: 특수 파일 형식 처리

**특징**:
- COM_LV0, COM_LV1, COM_LV2에 의존
- 특수 목적의 고급 기능 제공
- 선택적 사용 가능한 모듈들

---

## 주요 프로젝트 상세 설명

### 🔐 LOGIN 프로젝트

**역할**: 애플리케이션 진입점 및 버전 관리 시스템

**주요 파일**:
- `Nexmed_EHR_LOADER.dpr`: 로더 프로그램 (메인 진입점)
- `Loader.pas`: 로더 폼 및 버전 체크 로직
- `LoginCommon.pas`: 로그인 공통 기능
- `CoManager.pas`: 컴포넌트 관리

**작동 방식**:
1. **초기 실행**: 로더가 먼저 실행됨
2. **버전 체크**: 서버에서 최신 파일 버전 정보 조회
3. **파일 다운로드**: 
   - 로컬과 서버의 파일 버전 비교
   - 변경된 파일만 HTTP/HTTPS로 다운로드
   - LZMA 압축 해제 지원
4. **OCX/DLL 등록**: 필요한 ActiveX 컨트롤 자동 등록
5. **프로세스 관리**: 
   - 기존 실행 중인 프로세스 종료
   - 방화벽 예외 설정
6. **메인 실행**: `Nexmed_EHR.exe` 실행

**보안 기능**:
- HTTPS 통신 지원 (SSL/TLS)
- 파일 무결성 검증 (수정 시간 기반)
- 암호화된 설정 파일 (Base64 인코딩)
- 프로세스 보호 (중복 실행 방지)

**다른 프로젝트와의 관계**:
- → MAiN: 메인 프로그램 실행
- → COM_LV0~3: 필요한 DLL/BPL 파일 다운로드 및 등록

---

### 🏠 MAiN 프로젝트

**역할**: 메인 애플리케이션 및 사용자 인터페이스

**주요 파일**:
- `Nexmed_EHR.dpr`: 메인 프로그램 진입점
- `Main.pas`: 메인 폼 (TSMCMainForm)
- `MainHandler.pas`: 메인 이벤트 핸들러
- `Common.pas`: 공통 변수 및 함수
- `PatientForm.pas`: 환자 정보 폼
- `PatientList.pas`: 환자 목록 폼

**작동 방식**:
1. **초기화**:
   - LOGIN에서 실행됨
   - COM_LV0~3 패키지 동적 로드
   - 전역 변수 초기화
   - 설정 파일 로드

2. **로그인 처리**:
   - `dlgLogin` 폼 표시
   - 사용자 인증
   - 세션 정보 저장

3. **메인 화면 구성**:
   - 메뉴 시스템 로드
   - 툴바 구성
   - 도킹 패널 설정
   - 환자 목록 표시

4. **폼 관리**:
   - 동적 폼 로드 (BPL 패키지)
   - 폼 간 데이터 전달
   - 도킹 시스템 관리

5. **이벤트 처리**:
   - 메뉴 클릭 → 해당 모듈 실행
   - 환자 선택 → 환자 정보 표시
   - 알림 처리
   - 자동 로그아웃 타이머

**주요 기능**:
- MDI 스타일 인터페이스
- 동적 메뉴 시스템
- 환자 정보 관리
- 알림 시스템
- 로그 관리
- 다중 연결 감지

**다른 프로젝트와의 관계**:
- ← LOGIN: 실행 및 초기화
- → COM_LV2: SMC 프레임워크 사용
- → MDI, MDC, SD 등: 비즈니스 모듈 호출
- → EMR: 전자의무기록 모듈 호출

---

### 🔧 COM_LV0 프로젝트

**역할**: 기본 라이브러리 및 유틸리티

**주요 패키지**:

#### CommonPack
- **CommonFunc.pas**: 공통 함수 (문자열, 날짜, 파일 처리 등)
- **DCPsha256.pas**: SHA256 해시 함수
- **DCPbase64.pas**: Base64 인코딩/디코딩
- **DCPcrypt2.pas**: 암호화 유틸리티
- **PopupTree.pas**: 팝업 트리 컨트롤

#### ExternalPack
- 외부 ActiveX 컨트롤 래퍼
- 이미지 뷰어, 프린터, 스캐너 등
- 각종 의료기기 인터페이스

#### CPortLib
- 시리얼 포트 통신
- 바코드 스캐너 연동
- 의료기기 통신

**다른 프로젝트와의 관계**:
- 모든 상위 레벨의 기반
- 의존성 없음 (최하위 계층)

---

### 🎨 COM_LV1 프로젝트

**역할**: 써드파티 UI 컴포넌트 통합

**주요 구성**:
- **DevExpress**: 
  - Grid, Editor, Scheduler, Chart 등
  - 스킨 시스템
  - 프린팅 시스템
- **TMS**: 추가 UI 컴포넌트
- **SynEdit**: 코드 에디터
- **kbmMemTable**: 메모리 데이터셋

**특징**:
- 상용 라이브러리 통합
- UI 컴포넌트의 표준화
- COM_LV0에 의존

**다른 프로젝트와의 관계**:
- ← COM_LV0: 기본 라이브러리 사용
- → COM_LV2: SMC 프레임워크에서 사용

---

### 🏗️ COM_LV2 프로젝트

**역할**: 핵심 프레임워크 및 비즈니스 로직

**주요 패키지**:

#### SMC (핵심 프레임워크)
- **SMCMainCommon.pas**: 전역 변수 및 공통 기능
- **SMCForm.pas**: 기본 폼 클래스
- **SMCFormManager.pas**: 폼 관리 시스템
- **SMCMessageDialog.pas**: 메시지 다이얼로그
- **SMCMainDockControl.pas**: 도킹 시스템
- **SMCMainMenuToolBar.pas**: 메뉴/툴바 관리

#### SMCExpress
- DevExpress 기반 확장 컴포넌트
- SMCGrid, SMCButton, SMCInput 등
- 통일된 UI 스타일

#### SEHRCore / SEHRData
- EHR 데이터 모델
- 데이터셋 및 데이터 프로바이더
- REST API 클라이언트

#### SMCService
- 서비스 레이어
- 비즈니스 로직 처리
- 트랜잭션 관리

**핵심 기능**:
1. **폼 관리 시스템**:
   - 동적 폼 로드/언로드
   - 폼 간 데이터 전달
   - 폼 라이프사이클 관리

2. **데이터 처리**:
   - 데이터셋 관리
   - 데이터 프로바이더 패턴
   - REST API 통신

3. **UI 관리**:
   - 통일된 UI 컴포넌트
   - 스킨 시스템
   - 레이아웃 관리

**다른 프로젝트와의 관계**:
- ← COM_LV0, COM_LV1: 하위 레벨 사용
- → COM_LV3: 고급 기능 제공
- → MAiN: 메인 애플리케이션에서 사용
- → MDI, MDC, SD 등: 모든 비즈니스 모듈의 기반

---

### 🚀 COM_LV3 프로젝트

**역할**: 고급 기능 및 특수 컴포넌트

**주요 패키지**:

#### NRCViewerPackage
- 의무기록 뷰어
- 레거시 및 신규 버전 지원
- 다양한 리포트 형식 지원

#### SMCExport
- Excel, CSV 내보내기
- 리포트 생성

#### SMCFax
- 팩스 송수신
- 팩스 서버 연동

#### ScreenSecurityPack
- 화면 보안 기능
- 스크린샷 방지
- 화면 캡처 차단

#### SMCLProxy
- 프록시 및 링커
- 컴포넌트 간 연결 관리

**특징**:
- 선택적 사용 가능
- 특수 목적 기능
- COM_LV0~2에 의존

**다른 프로젝트와의 관계**:
- ← COM_LV0, COM_LV1, COM_LV2: 모든 하위 레벨 사용
- → MAiN, MDI 등: 필요시 사용

---

## 작동 방식

### 전체 실행 흐름

```
1. 사용자 실행
   ↓
2. LOGIN/Nexmed_EHR_LOADER.exe 실행
   ↓
3. 버전 체크 및 파일 다운로드
   ↓
4. OCX/DLL 등록
   ↓
5. MAiN/Nexmed_EHR.exe 실행
   ↓
6. 로그인 화면 표시
   ↓
7. 사용자 인증
   ↓
8. 메인 화면 로드
   ├─ COM_LV0~3 패키지 동적 로드
   ├─ 메뉴 시스템 구성
   ├─ 환자 목록 표시
   └─ 초기 데이터 로드
   ↓
9. 사용자 작업
   ├─ 메뉴 클릭 → 해당 모듈(BPL) 로드
   ├─ 환자 선택 → 환자 정보 표시
   ├─ 데이터 입력/조회 → 서버 통신
   └─ 리포트 생성/출력
   ↓
10. 종료
    ├─ 변경사항 저장
    ├─ 세션 종료
    └─ 리소스 해제
```

### 패키지 로딩 방식

1. **정적 링크**: 
   - COM_LV0, COM_LV1의 일부 패키지는 정적 링크
   - 실행 파일에 포함

2. **동적 로드 (BPL)**:
   - COM_LV2, COM_LV3의 대부분은 BPL(패키지)로 제공
   - 런타임에 필요시 로드
   - 메모리 효율성 향상

3. **모듈별 분리**:
   - MDI, MDC, SD 등은 각각 별도 BPL
   - 필요시에만 로드하여 시작 시간 단축

### 데이터 흐름

```
사용자 입력
   ↓
UI 컴포넌트 (COM_LV1, COM_LV2)
   ↓
SMC 프레임워크 (COM_LV2)
   ↓
데이터 프로바이더 (SEHRData)
   ↓
REST API 클라이언트
   ↓
서버 (백엔드)
   ↓
데이터베이스
```

---

## 보안 관련 사항

### 1. 통신 보안

#### HTTPS 통신
- **위치**: `LOGIN/Loader.pas`의 `Load2Config` 함수
- **구현**: 
  ```pascal
  IS_TRANSMIT_SSL := True;
  SSLHandler := TIdSSLIOHandlerSocketOpenSSL.Create(IdHTTPDownload);
  SSLHandler.SSLOptions.Method := sslvTLSv1_2;
  ```
- **용도**: 파일 다운로드 및 API 통신 시 암호화

#### 데이터 압축
- **구현**: ZLib 압축 사용
- **용도**: 네트워크 대역폭 절약 및 성능 향상

### 2. 인증 및 권한

#### 로그인 시스템
- **위치**: `MAiN/Dlg/dlgLogin.pas`
- **기능**:
  - 사용자 ID/비밀번호 인증
  - 세션 관리
  - 자동 로그아웃 타이머

#### 인증서 처리
- **패키지**: `COM_LV2/SMCCert`
- **기능**: 공인인증서, 의료인증서 처리

### 3. 데이터 보안

#### 암호화
- **SHA256 해시**: `COM_LV0/CommonPack/DCPsha256.pas`
- **Base64 인코딩**: `COM_LV0/CommonPack/DCPbase64.pas`
- **용도**: 비밀번호 해시, 설정 파일 암호화

#### 화면 보안
- **패키지**: `COM_LV3/ScreenSecurityPack`
- **기능**:
  - 스크린샷 방지
  - 화면 캡처 차단
  - 민감 정보 보호

### 4. 파일 무결성

#### 버전 관리
- **위치**: `LOGIN/Loader.pas`
- **기능**:
  - 파일 수정 시간 기반 버전 체크
  - 서버와 로컬 파일 비교
  - 무결성 검증

#### 파일 다운로드 보안
- HTTPS 통신
- 압축 파일 검증
- 임시 파일 안전 삭제

### 5. 프로세스 보안

#### 중복 실행 방지
- **위치**: `LOGIN/Loader.pas`의 `MainAliveCheck` 함수
- **기능**: 동일 프로그램 중복 실행 감지 및 처리

#### 프로세스 종료 관리
- 안전한 프로세스 종료
- 리소스 정리
- 예외 처리

### 6. 설정 파일 보안

#### 암호화된 설정
- **위치**: `LOGIN/Loader.pas`의 `Load2Config`
- **기능**: Base64 인코딩된 설정 값 디코딩
- **용도**: 서버 주소, 포트 등 민감 정보 보호

---

## 프로젝트 간 의존성 관계

### 의존성 다이어그램

```
LOGIN
  ↓ (실행)
MAiN
  ↓ (사용)
COM_LV2 (SMC 프레임워크)
  ↓ (사용)
COM_LV1 (써드파티 컴포넌트)
  ↓ (사용)
COM_LV0 (기본 라이브러리)

COM_LV3 (고급 기능)
  ↓ (사용)
COM_LV2, COM_LV1, COM_LV0

MDI, MDC, SD, EMR 등 (비즈니스 모듈)
  ↓ (사용)
COM_LV2, COM_LV1, COM_LV0
```

### 상세 의존성

#### LOGIN
- **의존**: COM_LV0 (CommonPack), COM_LV2 (SMC 프레임워크 일부)
- **제공**: MAiN 실행

#### MAiN
- **의존**: 
  - COM_LV0: 기본 유틸리티
  - COM_LV1: UI 컴포넌트
  - COM_LV2: SMC 프레임워크 (필수)
  - COM_LV3: 고급 기능 (선택)
- **제공**: 사용자 인터페이스, 모듈 관리

#### COM_LV0
- **의존**: 없음 (최하위 계층)
- **제공**: 모든 상위 레벨에 기본 기능

#### COM_LV1
- **의존**: COM_LV0
- **제공**: UI 컴포넌트, 데이터 처리 컴포넌트

#### COM_LV2
- **의존**: COM_LV0, COM_LV1
- **제공**: 핵심 프레임워크, 비즈니스 로직 기반

#### COM_LV3
- **의존**: COM_LV0, COM_LV1, COM_LV2
- **제공**: 고급 기능, 특수 컴포넌트

### 패키지 로딩 순서

1. **시작 시**:
   - COM_LV0 (정적 링크)
   - COM_LV1 (정적 링크)
   - COM_LV2/SMC (동적 로드)
   - COM_LV2/SMCExpress (동적 로드)

2. **필요 시**:
   - COM_LV3 패키지들
   - 비즈니스 모듈 (MDI, MDC, SD 등)

---

## 요약

### 각 프로젝트의 핵심 역할

| 프로젝트 | 역할 | 의존성 | 특징 |
|---------|------|--------|------|
| **LOGIN** | 진입점, 버전 관리 | COM_LV0, COM_LV2 | 자동 업데이트, 보안 |
| **MAiN** | 메인 애플리케이션 | 모든 COM_LV 레벨 | 사용자 인터페이스 |
| **COM_LV0** | 기본 라이브러리 | 없음 | 최하위 계층 |
| **COM_LV1** | 써드파티 컴포넌트 | COM_LV0 | UI 컴포넌트 |
| **COM_LV2** | 핵심 프레임워크 | COM_LV0, COM_LV1 | 비즈니스 로직 기반 |
| **COM_LV3** | 고급 기능 | 모든 하위 레벨 | 특수 기능 |

### 작동 원리

1. **계층형 아키텍처**: 명확한 계층 분리로 유지보수성 향상
2. **동적 로딩**: BPL 패키지 시스템으로 메모리 효율성
3. **모듈화**: 기능별 모듈 분리로 확장성 확보
4. **보안 강화**: HTTPS, 암호화, 화면 보안 등 다층 보안

### 보안 특징

- ✅ HTTPS 통신
- ✅ 파일 무결성 검증
- ✅ 암호화된 설정
- ✅ 화면 보안
- ✅ 프로세스 보호
- ✅ 인증서 처리

---

**작성일**: 2024년
**버전**: 1.0

